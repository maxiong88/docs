---
title: '动态语言与闭包'
description: '闭包、作用域'
sidebar: 'auto'
time: '2019-02-28'
tags: 'javascript'
prev: ''
next: ''
---

摘自 js王者归来

摘自 HEAD FIRST JAVASCRIPT：

## 词法作用域

`词法作用域` 意味着通过阅读代码就能确定变量的作用域。

#### 你说词法作用域决定了变量是在哪里定义的，这是什么意思？

所谓词法作用域，指的是JavaScript的作用域规则完全基于代码的结构，而不是一些动态的运行阶段属性。这意味着只需查看代码的结构，就能确定变量是在什么地方定义的。另外别忘了，在JavaScript中，只有函数会引入新的作用域。因此，对于在函数中引用的变量，要确定它是在哪里定义的，可从最里面（当前函数）开始依次向最外面进行查找，直到找到它为止。如果在这些函数中都找不到它，则它要么是全局的，要么未定义。 

#### 在函数被嵌套很多层的情况下，环境的工作原理是什么呢？ 

在环境中查找变量时，你将从最近的环境着手，沿环境链不断往下查找，直到找到变量为止。如果在环境链中没有找到，再在全局环境中查找。

::: tip 别忘了
JavaScript函数都是在定义它的环境中执行的。在函数中，要确定变量来自何方，可按从内到外的顺序依次在包含它的函数中搜索。
:::

## 闭包

闭包指的是函数及其引用的环境。捕获其创建时所处作用域内的变量的值。

在创建闭包的上下文外部执行它时，自由变量的值由引用的环境决定。

::: tip 被称为闭包
包含自由变量的函数与为所有这些自由变量提供了变量绑定的环境一起
:::

#### 什么是自由变量

函数通常包含`局部变量`（它们是在函数体中定义的，包括所有的形参），还可能包含不是在本地定义(在当前函数环境下定义)的变量，这些变量被称为`自由变量`。自由一词源于这样一点：在函数体内，自由变量没有绑定到任何值（换而言之，它们 不是在本地声明的）。有了给每个自由变量都提供了值的环境后，便将函数敲定了；而函数和环境一起被称为闭包。

对于函数体内的变量，如果它既不是在本地定义的，又不是全局变量， 便可肯定它来自包含当前函数的其他函数，可从环境中获取其值。


``` js
var secret = "007"; 
function getSecret() {    
	var secret = "008";    
	function getValue() {        
		return secret;    // 在getValue中，secret 是一个自由变量
	}    
	return getValue; // 在这里，我们创建了一个闭包，并将其从getSecret返回。
} 
var getValueFun = getSecret(); 
getValueFun(); // 因此，当我们在另一个上下文（全局作用域）中 调用getValueFun（即getValue）时，将使用其环境中的变量secret的值。
```


## 动态语言与闭包(closure)

闭包成了编程语言的一个重要概念

几乎所有的知名动态语言(php、c)都支持闭包，javascript也不例外

一小段可重用的代码（一个可调用的函数）能够处理并可选地保留一个上下文。

### 动态语言与动态类型语言

`动态语言`指：程序在运行时可以改变其结构；新的函数可以被引进，已有的函数可以被删除等在结构上的变化。

动态类型语言是指在运行期间才去发现数据类型的语言，++说的是数据类型++

动态语言说的是运行是改变结构，++说的是代码结构++。

::: tip
大多数动态语言都是动态类型语言，但动态语言本身并不要求一定是动态类型的，而动态类型语言也不一定是动态语言
:::

### 语法域和执行域

语法域,指定义某个程序段落时的区域

执行域，指实际调用某个程序段落时所影响的区域

``` js 
动态语言如js的函数不但能够访问语法域上的这些范围，还能访问它外层环境中的执行域范围

<!--
// 产生随机数函数
function RandomAlert(){
	var x = Math.random()
	return function(){
		alert(x)
	}
}
var a = RandomAlert();
	// 闭包的执行域随函数调用而创建
var b = RandomAlert();
a()
b()
// 一般情况下，a与b得到的数值不同
-->

```

### js闭包

在程序语言中，闭包，指语法域位于某个特定的区域，具有持续参照位于该区域内自身范围之外的执行域上的非持久型变量值能力的段落。这些外部执行域的非持久型变量神奇地保留它们在闭包最初定义时的值

从上可以看出，闭包通常是在动态语言中才有的概念，它是某些可以访问外部执行域的段落。

js中的闭包，是通过定义在函数体内部的`function`来实现

1.2中就是典型的闭包应用，RandomAlert函数的返回值是一个闭包，
a(), b() 分别访问了 闭包 两次被创建时 对应的外层RandomAlert()函数的执行域 上的局部变量x的值

闭包跟函数关系，类似与一种动态和静态、结构和实例的关系


### 闭包的内在----自治的领域

闭包的 闭 是指闭包的内部环境对外部不可见，
也就是说闭包具有控制外部域的能力但是又能防止
外部域对闭包的反向控制。换句话，`闭包的领域是对外封闭的`。

此特点不用过多解释，因为js闭包是通过function实现的，
所以它天然具有基本的函数特征，在闭包内声明的变量，
闭包外的任何环境中都无法访问，除非闭包向外部环境提供了访问
他们的接口。

``` js
function dwn(s){
	document.write(s)
}
我们说匿名函数调用产生一个 `瞬时` 的闭包
因此当调用结束后，私有变量无法访问，并且如果没有外部引用存在
内部对象就会被销毁.
而如果反回了函数，或者被全局引用，则 闭包 被保留了下来
闭包中的内容被 有选择 地开放出来
(function(){
	// 封闭的私有域 私有变量
	var unnerX = 10,innerY = 20;
	// 开放的公共域 全局变量
	outerObj = {x : innerX, y : innerY}
})();

try{
	dwn(innerX) // 内部数据无法访问
}catch(ex){
	dwn('内部数据无法访问');
}
dwn(outerObj.X) // 通过外部接口访问

```

### 访问外部环境

闭包不但可以读外部变量，也可以写外部变量

## 总结

+ 我们定义的函数，不管返不返回、不管有没有引用自由变量、不管自由变量是全局的还是局部的，都是闭包。闭包有自治的领域
+ 闭包不但可以读外部变量，也可以写外部变量





