---
title: JavaScript之旅：从下载脚本到执行 - 第一部分
---



[转载](//www.telerik.com/blogs/journey-of-javascript-downloading-scripts-to-execution-part-i)


:::tip
本文将帮助您理解JavaScript的内部结构---甚至是奇怪的部分。

一旦您知道底层引擎是如何解释的，您用javascript编写的每一行代码都将完全有意义。

您将学习基于用例下载脚本的多种方法，以及解析器如何在解析代码时生成抽象语法树及其启发式方法。

让我们从下载脚本开始深入了解JavaScript引擎的内部。
:::

我们还将了解我们的代码如何被底层JavaScript引擎解析，解释和编译，以及哪些代码最适合我们的引擎。虽然JavaScript的语法很容易掌握，但理解其内部结构是一项更艰巨的任务。我们将从基础开始，最终掌握它。我们走吧。

一些最基础的文件请看原文，这里省略掉了

### 了解脚本标记

``` html
<!DOCTYPE html>
<html>
    <head>
        <script src='./js/first.js'></script>
        <script src='./js/second.js'></script>
        <script src='./js/third.js'></script>
        <script src='./js/fourth.js'></script>
    </head>
    <body>
        <div>Understanding the script tag</div>
    </body>
</html>
```

浏览器开始解析HTML代码。当它遇到head部分中的脚本标记时，HTML解析将暂停。HTTP请求被发送到服务器以获取脚本。浏览器等待，直到下载整个脚本。然后它完成解析，解释和执行下载脚本的工作（我们将在本文后面详细介绍整个过程）。四个脚本中的每一个都会发生这种情况。

完成此操作后，浏览器将恢复解析HTML和创建DOM节点的工作。耐心地盯着屏幕等待加载某些东西的用户并不知道他的大部分时间都花在执行JavaScript代码上（即使是在启动期间可能不需要的代码）。脚本标签本质上是阻塞的。它们阻止了DOM的渲染。你的高中老师可能会告诉你，“总是把脚本标签放在正文下面。”现在你知道脚本标签阻止了DOM的渲染，将它们放在HTML下面是有意义的。

下一个显而易见的问题是：我们何时应该加载脚本 - 在解析HTML之前的开始或HTML之后的结尾？让我们再分析一下这个问题吧。

我们的最终目标很明确 - 在启动期间立即加载资产。我们首先解析脚本然后HTML的方法提供了良好的用户体验，但是当内容被执行时，它通过向他显示空白屏幕来占用大量用户的时间。这种方法的问题在于随着脚本数量的增加而变得更糟，因为等待时间（加载时间）与脚本数量成正比。对于每个脚本，我们都会前往服务器并等待下载。

我们可以减少http请求数

+ 打包到一个js文件
+ 按需加载js文件

### 异步下载脚本 async关键字作用

在脚本标记中添加async关键字时，浏览器会异步下载脚本，浏览器不会暂停DOM解析，脚本在另一个线程中下载不会干扰主线程，一旦下载完成，浏览器停止解析DOM并忙于解析脚本代码。脚本解析完成以后，浏览器将恢复解析html的工作

`<script async src=''>`

### 推迟执行脚本 defer关键字作用

在脚本标记中添加defer关键字时，浏览器在HTML解析完成之前不会执行该脚本。延迟只是意味着延迟或延迟执行文件。该脚本在另一个线程中下载，仅在HTML解析完成后执行。

`<script defer src=''>`

### 三者之间的区别？
* script
 * 当解析器遇到 script 标签时，文档的解析将停止，并立即下载并执行脚本，脚本执行完毕后将继续解析文档。
* defer script
 * 当解析器遇到 script 标签时，文档的解析不会停止，其他线程将下载脚本，待到文档解析完成，脚本才会执行。
* async script
 * 当解析器遇到 script 标签时，文档的解析不会停止，其他线程将下载脚本，脚本下载完成后开始执行脚本，脚本执行的过程中文档将停止解析，直到脚本执行完毕。

### 什么情况下使用 defer 和 async？
* 如果脚本不依赖于任何脚本，并不被任何脚本依赖，那么则使用 defer。
* 如果脚本是模块化的，不依赖于任何脚本，那么则使用 async。

到目前为止，我们已经了解了`如何下载脚本`以及`下载脚本的最有效方法`。让我们了解下载脚本后会发生什么。

+ (Parser)解析器--将javascript输入解析器，生成抽象语法树
+ (Interpreter)解释器--抽象语法树可以开启V8解释器模式，它生成`ByteCode`字节码
+ (Compiler)编译器-V8引擎的[TurboFan](https://v8.dev/docs/turbofan)编译器接受字节码并生成机器代码
+ (Optimizing Compiler)优化编译器-它以字节码和一些分析数据为入口，生成优化的机器代码。
